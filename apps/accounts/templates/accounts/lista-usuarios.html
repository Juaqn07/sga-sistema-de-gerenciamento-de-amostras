{% extends "core/base.html" %}
{% load static %}
{% block title %}
  Gerenciar Usuários
{% endblock title %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-0">Gerenciar Usuários</h3>
      <small>Adicione, edite ou inative usuários do sistema</small>
    </div>
    <div>
      <a href="{% url 'accounts:criar_usuario' %}" class="btn btn-primary">
        <i class="bi bi-person-plus me-2"></i> Cadastrar Novo Usuário
      </a>
    </div>
  </div>
  <div class="card shadow-sm">
    <div class="card-header bg-white border-0 pt-4 pb-0">
      <form method="GET">
        <div class="input-group">
          <input type="text"
                 class="form-control"
                 placeholder="Buscar por nome, usuário ou email..."
                 name="q"
                 value="{{ query|default:'' }}">
          <button class="btn btn-outline-secondary" type="submit">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </form>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 border">
          <thead class="table-light">
            <tr>
              <th>Nome</th>
              <th>Email</th>
              <th>Função</th>
              <th>Setor</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for usuario in page_obj %}
              <tr class="{% if not usuario.is_active %}table-light text-muted{% endif %}">
                <td>
                  <div class="fw-bold text-limit mw-200px"
                       title="{{ usuario.get_full_name|default:usuario.username }}">
                    {{ usuario.get_full_name|default:usuario.username }}
                  </div>
                  {% if not usuario.is_active %}<span class="badge bg-secondary ms-1">Inativo</span>{% endif %}
                </td>
                <td>
                  <div class="text-limit mw-250px" title="{{ usuario.email|default:'N/A' }}">{{ usuario.email|default:"N/A" }}</div>
                </td>
                <td>{{ usuario.funcao|default:"N/A" }}</td>
                <td>
                  <div class="text-limit mw-150px" title="{{ usuario.setor|default:'N/A' }}">{{ usuario.setor|default:"N/A" }}</div>
                </td>
                <td class="text-center">
                  <a href="{% url 'accounts:editar_usuario' usuario.id %}"
                     class="btn btn-sm btn-outline-secondary"
                     title="Editar">
                    <i class="bi bi-pencil"></i>
                  </a>
                  {% if usuario.is_active %}
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            title="Inativar"
                            data-bs-toggle="modal"
                            data-bs-target="#modalInativarUser{{ usuario.id }}">
                      <i class="bi bi-person-x"></i>
                    </button>
                  {% else %}
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            disabled
                            title="Usuário Inativo">
                      <i class="bi bi-slash-circle"></i>
                    </button>
                  {% endif %}
                </td>
              </tr>
              <div class="modal fade"
                   id="modalInativarUser{{ usuario.id }}"
                   tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Confirmar Inativação</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <p>
                        Tem certeza que deseja <strong>inativar</strong> o usuário <strong>{{ usuario.get_full_name|default:usuario.username }}</strong>?
                      </p>
                      <p class="text-muted small">
                        O usuário perderá o acesso ao sistema imediatamente, mas seus dados históricos (processos criados, comentários)
                        <strong>serão mantidos</strong>.
                      </p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <form action="{% url 'accounts:deletar_usuario' usuario.id %}"
                            method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Sim, inativar</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted p-4">Nenhum usuário encontrado.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% if page_obj.paginator.num_pages > 1 %}
      <div class="card-footer d-flex justify-content-end">
        <nav>
          <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1&q={{ query|default:'' }}">« Primeira</a>
              </li>
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&q={{ query|default:'' }}">Anterior</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">« Primeira</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">Anterior</span>
              </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active" aria-current="page">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}&q={{ query|default:'' }}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&q={{ query|default:'' }}">Próxima</a>
              </li>
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.paginator.num_pages }}&q={{ query|default:'' }}">Última »</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Próxima</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">Última »</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
{% endblock content %}
