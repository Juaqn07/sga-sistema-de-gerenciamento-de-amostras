{% extends "core/base.html" %}
{% load static %}
{% block title %}
  Detalhes do Processo {{ processo.codigo }}
{% endblock title %}
{% block page_css %}
  <link rel="stylesheet"
        href="{% static 'samples/css/detalhes-processo.css' %}">
{% endblock page_css %}
{% block content %}
  <form style="display: none;">
    {% csrf_token %}
  </form>
  <div class="process-wrapper">
    <div class="page-header d-flex justify-content-between align-items-center">
      <div>
        <a href="{% url 'samples:lista_processos' %}"
           class="btn-back mb-2 d-block">
          <i class="bi bi-arrow-left"></i> Voltar para a Lista
        </a>
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <h2>{{ processo.codigo }}</h2>
          <span class="badge {{ processo.get_status_classe_css }}">{{ processo.get_status_display }}</span>
          <span class="badge {{ processo.get_prioridade_classe_css }}">{{ processo.get_prioridade_display }}</span>
        </div>
        <p class="text-muted fs-5 mb-0 text-break">{{ processo.titulo }}</p>
      </div>
      <div class="d-flex gap-2">
        {% if not processo.is_cancelado %}
          {% if user.funcao == 'Separador' %}
            <button class="btn btn-primary" ...>Alterar Status</button>
            <button class="btn btn-outline-secondary" ...>Código</button>
          {% endif %}
          {% if user.funcao == 'Separador' and not processo.responsavel_separacao %}
            <button class="btn btn-success" onclick="atribuirProcesso({{ processo.id }})">...</button>
          {% endif %}
        {% endif %}
        {% if user.funcao == 'Gestor' or user == processo.criado_por %}
          {% if processo.is_cancelado %}
            <button class="btn btn-outline-success"
                    onclick="toggleCancelar({{ processo.id }}, 'reativar')">
              <i class="bi bi-arrow-counterclockwise me-2"></i> Reativar Processo
            </button>
          {% else %}
            <button class="btn btn-outline-danger"
                    onclick="toggleCancelar({{ processo.id }}, 'cancelar')">
              <i class="bi bi-x-circle me-2"></i> Cancelar
            </button>
          {% endif %}
        {% endif %}
        <button class="btn btn-outline-secondary">
          <i class="bi bi-three-dots"></i>
        </button>
      </div>
    </div>
    <div class="row g-4 mt-2">
      <div class="col-lg-8 process-layout-main">
        <div class="card mb-4">
          <div class="card-body p-4">
            <h5 class="card-title fw-semibold">Informações do Processo</h5>
            <h6 class="mt-4 text-muted small text-uppercase">Descrição</h6>
            <p class="mt-1">{{ processo.descricao|linebreaks }}</p>
            <h6 class="mt-4 text-muted small text-uppercase">Tipos de Amostra</h6>
            <div class="d-flex flex-wrap gap-2 mt-1">
              {% for tipo in processo.tipos_amostra.all %}
                <span class="badge bg-light text-dark border">{{ tipo.nome }}</span>
              {% endfor %}
            </div>
            <div class="info-card-footer d-flex justify-content-between mt-4 pt-3 border-top">
              <div class="info-item text-muted small">
                <i class="bi bi-person me-1"></i>
                Criado por <strong>{{ processo.criado_por.get_full_name|default:processo.criado_por.username }}</strong>
              </div>
              <div class="info-item text-muted small">
                <i class="bi bi-calendar-event me-1"></i>
                Criado em <strong>{{ processo.data_criacao|date:"d/m/Y H:i" }}</strong>
              </div>
              {% if processo.responsavel_separacao %}
                <div class="info-item text-muted small">
                  <i class="bi bi-person-check me-1"></i>
                  Responsável: <strong>{{ processo.responsavel_separacao.get_full_name }}</strong>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="processTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        id="timeline-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#timeline"
                        type="button"
                        role="tab">Histórico</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="anexos-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#anexos"
                        type="button"
                        role="tab">
                  Anexos <span class="badge bg-secondary ms-1">{{ processo.anexos.count }}</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="comentarios-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#comentarios"
                        type="button"
                        role="tab">
                  Comentários <span class="badge bg-secondary ms-1">{{ processo.comentarios.count }}</span>
                </button>
              </li>
            </ul>
          </div>
          <div class="card-body p-4 tab-content">
            <div class="tab-pane fade show active" id="timeline" role="tabpanel">
              <h5 class="fw-semibold mb-3">Linha do Tempo</h5>
              <ul class="process-timeline">
                {% for evento in processo.timeline.all|dictsortreversed:"data" %}
                  <li class="timeline-item">
                    <div class="timeline-icon">
                      <i class="bi {{ evento.icone }}"></i>
                    </div>
                    <div class="timeline-content">
                      <strong>{{ evento.titulo }}</strong>
                      <small class="d-block text-muted">
                        Por {{ evento.autor.get_full_name|default:"Sistema" }} • {{ evento.data|date:"d/m/Y H:i" }}
                      </small>
                      {% if evento.descricao %}<div class="timeline-note mt-2">{{ evento.descricao }}</div>{% endif %}
                    </div>
                  </li>
                {% empty %}
                  <li class="text-muted">Nenhum evento registrado.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="tab-pane fade" id="anexos" role="tabpanel">
              {% if not processo.is_cancelado %}
                <div class="mb-4 p-3 bg-light rounded border">
                  <form method="POST"
                        enctype="multipart/form-data"
                        class="row g-2 align-items-end">
                    <input type="hidden" name="upload_anexos" value="1">
                    <div class="col-md-9">
                      <label class="form-label small fw-bold text-uppercase">Adicionar Novos Arquivos</label>
                      {{ anexo_form.arquivo }}
                    </div>
                    <div class="col-md-3">
                      <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload me-1"></i> Enviar
                      </button>
                    </div>
                  </form>
                </div>
              {% else %}
                <div class="alert alert-dark text-center mb-4">
                  <i class="bi bi-lock-fill me-2"></i> Este processo está cancelado. Não é possível adicionar anexos.
                </div>
              {% endif %}
              {% if processo.anexos.exists %}
                <div class="list-group">
                  {% for anexo in processo.anexos.all|dictsortreversed:"data_upload" %}
                    <a href="{{ anexo.arquivo.url }}"
                       target="_blank"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                      <div>
                        <i class="bi bi-file-earmark-text me-2 text-primary"></i>
                        {{ anexo.nome_arquivo }}
                      </div>
                      <small class="text-muted">{{ anexo.data_upload|date:"d/m/Y H:i" }}</small>
                    </a>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted text-center my-4">Nenhum anexo encontrado.</p>
              {% endif %}
            </div>
            <div class="tab-pane fade" id="comentarios" role="tabpanel">
              {% if not processo.is_cancelado %}
                <div class="mb-3 text-end">
                  <button class="btn btn-sm btn-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#modalAddComentario"
                          data-processo-pk="{{ processo.id }}"
                          data-processo-id="{{ processo.codigo }}"
                          data-processo-titulo="{{ processo.titulo }}">
                    <i class="bi bi-plus-lg"></i> Novo Comentário
                  </button>
                </div>
              {% else %}
                <div class="alert alert-dark text-center mb-3">
                  <i class="bi bi-lock-fill me-2"></i> Comentários desativados para processos cancelados.
                </div>
              {% endif %}
              {% if processo.comentarios.exists %}
                {% for comentario in processo.comentarios.all|dictsortreversed:"data" %}
                  <div class="d-flex mb-3 pb-3 border-bottom">
                    <div class="me-3">
                      {% if comentario.autor.foto %}
                        <img src="{{ comentario.autor.foto.url }}"
                             class="rounded-circle"
                             width="40"
                             height="40"
                             alt="Foto do(a) Autor(a) do Comentário">
                      {% else %}
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                             style="width: 40px;
                                    height: 40px">{{ comentario.autor.first_name|first }}</div>
                      {% endif %}
                    </div>
                    <div>
                      <div class="d-flex align-items-center mb-1">
                        <strong class="me-2">{{ comentario.autor.get_full_name }}</strong>
                        <small class="text-muted">{{ comentario.data|date:"d/m/Y H:i" }}</small>
                        {% if comentario.encaminhar_gestao %}
                          <span class="badge bg-danger-subtle text-danger ms-2">Ocorrência</span>
                        {% endif %}
                      </div>
                      <p class="mb-0">{{ comentario.texto|linebreaks }}</p>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <p class="text-muted text-center my-4">Nenhum comentário ou ocorrência.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4 process-layout-sidebar">
        <div class="card mb-4 details-card">
          <div class="card-header bg-light">
            <h6 class="mb-0 fw-bold">Cliente</h6>
          </div>
          <div class="card-body p-4">
            <div class="detail-item">
              <label>Razão Social</label>
              <p>{{ processo.cliente.nome }}</p>
            </div>
            <div class="detail-item">
              <label>A/C (Responsável)</label>
              <p>{{ processo.cliente.responsavel }}</p>
            </div>
            <div class="detail-item">
              <label>Endereço</label>
              <p>{{ processo.cliente.logradouro }}, {{ processo.cliente.numero }}</p>
              <p class="text-muted small">
                {{ processo.cliente.bairro }} - {{ processo.cliente.cidade }}/{{ processo.cliente.estado }}
              </p>
              <p class="text-muted small">CEP: {{ processo.cliente.cep }}</p>
            </div>
          </div>
        </div>
        <div class="card mb-4 details-card">
          <div class="card-header bg-light">
            <h6 class="mb-0 fw-bold">Dados Técnicos</h6>
          </div>
          <div class="card-body p-4">
            <div class="detail-item">
              <label>Transporte</label>
              <p>{{ processo.get_tipo_transporte_display }}</p>
            </div>
            <div class="detail-item">
              <div class="d-flex justify-content-between align-items-center">
                <label>
                  Código
                  {% if processo.tipo_transporte == 'carga' %}
                    Carga
                  {% else %}
                    Rastreio
                  {% endif %}
                </label>
                {% if user.funcao == 'Separador' and not processo.is_cancelado %}
                  <a href="#"
                     class="text-primary"
                     data-bs-toggle="modal"
                     data-bs-target="#modalCodigoRastreio"
                     data-processo-pk="{{ processo.id }}"
                     data-processo-id="{{ processo.codigo }}"
                     data-processo-titulo="{{ processo.titulo }}"
                     data-processo-rastreio="{{ processo.codigo_rastreio|default:'' }}">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                {% elif processo.tipo_transporte == 'carga' and processo.criado_por == user and not processo.is_cancelado %}
                  <a href="#"
                     class="text-primary"
                     data-bs-toggle="modal"
                     data-bs-target="#modalCodigoRastreio"
                     data-processo-pk="{{ processo.id }}"
                     data-processo-id="{{ processo.codigo }}"
                     data-processo-titulo="{{ processo.titulo }}"
                     data-processo-rastreio="{{ processo.codigo_rastreio|default:'' }}">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                {% endif %}
              </div>
              {% if processo.codigo_rastreio %}
                <p class="font-monospace">{{ processo.codigo_rastreio }}</p>
              {% else %}
                <p class="text-muted fst-italic">Não informado</p>
              {% endif %}
            </div>
            {% if processo.codigo_pedido_iniflex %}
              <div class="detail-item">
                <label>Pedido Iniflex</label>
                <p class="font-monospace">{{ processo.codigo_pedido_iniflex }}</p>
              </div>
            {% endif %}
            <div class="detail-item mb-0">
              <label>Última Atualização</label>
              <p>{{ processo.ultima_atualizacao|date:"d/m/Y H:i" }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% include "samples/includes/modais-processos.html" %}
{% endblock content %}
{% block page_js %}
  <script src="{% static 'samples/js/processos-do-setor.js' %}"></script>
{% endblock page_js %}
